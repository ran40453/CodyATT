<script>
  // å…¨åŸŸè®Šæ•¸ï¼ˆä¾› Analytics åŠŸèƒ½ä½¿ç”¨ï¼‰
  let tableData = [];
  let newRowTravelEnabled = true;
  let selectedMonth = null;
  let charts = {};
  let availableMonths = [];

  ; (function (global) {
    // åœ¨ Apps Scriptï¼ˆå¾Œç«¯ï¼‰ä¹Ÿæœƒè¼‰å…¥é€™å€‹æª”æ¡ˆï¼Œä½†æ²’æœ‰ window / documentï¼Œæ‰€ä»¥é€™è£¡ç”¨ globalThis/this åšé˜²å‘†
    if (!global || !global.document) {
      return;
    }
    global.__BUILD_TAG__ = '2025-12-04-v2';
    console.log('[OT] BUILD', global.__BUILD_TAG__);

    // è®Šæ•¸å·²ç§»è‡³å…¨åŸŸ

    function getWeekdayChar(dateStr) {
      const date = new Date(dateStr);
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      return weekdays[date.getDay()];
    }

    function formatDateYYYYMMDD(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // æ ¹æ“šè¼¸å…¥è¨­å®šçš„åœ‹å®¶ï¼Œæ±ºå®šæ¯æ—¥ Travel USDï¼ˆChina:33, Vietnam:40, India:80ï¼‰
    function getTravelUsdByCountry() {
      const select = document.getElementById('travelCountry');
      const country = select?.value || 'Vietnam';
      if (country === 'China') return 33;
      if (country === 'India') return 80;
      return 40; // Vietnam é è¨­
    }

    // æ›´æ–°: é‡æ–°è¨ˆç®—æ‰€æœ‰è³‡æ–™ï¼Œä¸¦é‡æ–°æ¸²æŸ“
    function updateAll(openIndex = null, skipRender = false) {
      const salary = parseFloat(document.getElementById('salary')?.value) || 60000;
      const rate = parseFloat(document.getElementById('usdRate')?.value) || 30.9;
      const travelUsdPerDay = getTravelUsdByCountry();

      let accum = 0;
      const monthTravelSums = {}; // key: 'YYYY-MM' -> è©²æœˆ Travel åŠ ç¸½
      const monthOtSalarySums = {}; // key: 'YYYY-MM' -> è©²æœˆ OT Salary åŠ ç¸½

      // ç”±å‰ç«¯ä¾ salary / rate / travel è¨­å®šé‡æ–°è¨ˆç®—
      tableData.forEach((entry) => {
        const otSum =
          (Number(entry.v167) || 0) * 1.67 +
          (Number(entry.v134) || 0) * 1.34 +
          (Number(entry.v166) || 0) * 1.66 +
          (Number(entry.v267) || 0) * 2.67;

        if (typeof entry.travelEnabled === 'undefined') {
          entry.travelEnabled = true;
        }

        const base = salary / 30;
        const travel = entry.travelEnabled ? travelUsdPerDay * rate : 0;
        const otSalary = (salary / 30 / 8) * otSum;
        const total = base + travel + otSalary;

        accum += total;

        entry.weekday = getWeekdayChar(entry.date);
        entry.otSum = otSum.toFixed(2);
        entry.base = base.toFixed(2);
        entry.travel = travel.toFixed(2);
        entry.otSalary = otSalary.toFixed(2);
        entry.total = total.toFixed(2);
        entry.accum = accum.toFixed(2);

        // ä¾æœˆä»½ç´¯ç©ï¼šç•¶æœˆ Travel èˆ‡ OT Salaryï¼ˆä¸å« Baseï¼‰
        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        if (monthKey) {
          monthTravelSums[monthKey] = (monthTravelSums[monthKey] || 0) + travel;
          monthOtSalarySums[monthKey] = (monthOtSalarySums[monthKey] || 0) + otSalary;
        }
      });

      // ä¾æœˆä»½å›å¯«ã€Œæœˆè–ªã€æ¬„ä½ï¼šè©²æœˆå®Œæ•´ Baseï¼ˆsalaryï¼‰+ ç•¶æœˆ Travel åŠ ç¸½ + ç•¶æœˆ OT Salary åŠ ç¸½
      tableData.forEach((entry) => {
        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        let monthSLR = 0;
        if (monthKey) {
          const travelSum = monthTravelSums[monthKey] || 0;
          const otSalarySum = monthOtSalarySums[monthKey] || 0;
          // æœˆè–ª = ç•¶æœˆå®Œæ•´ Base (salary) +ç•¶æœˆ Travel åŠ ç¸½ + ç•¶æœˆ OT Salary åŠ ç¸½
          monthSLR = salary + travelSum + otSalarySum;
        }
        entry.monthSLR = monthSLR.toFixed(2);
      });

      if (!skipRender) {
        renderTable(openIndex);
      } else {
        // åªæ›´æ–°è¡¨æ ¼å…§ç¾æœ‰çš„æ•¸å€¼ï¼Œä¸é‡æ–°æ¸²æŸ“
        updateTableValues();
      }
      updateDashboard();
    }

    // æ›´æ–°è¡¨æ ¼ä¸­å·²æ¸²æŸ“çš„æ•¸å€¼ï¼ˆä¸é‡æ–°å»ºç«‹ DOMï¼‰
    function updateTableValues() {
      const rows = document.querySelectorAll('.data-row');
      rows.forEach((row, index) => {
        const entry = tableData[index];
        if (!entry) return;

        // æ›´æ–° OT æ•¸å€¼é¡¯ç¤º
        const steppers = row.querySelectorAll('.stepper-value');
        steppers.forEach((valueSpan, i) => {
          const keys = ['v167', 'v134', 'v166', 'v267'];
          if (entry[keys[i]] !== undefined) {
            valueSpan.textContent = entry[keys[i]];
            // æ›´æ–° class
            if (entry[keys[i]] > 0) {
              valueSpan.classList.add('has-value');
            } else {
              valueSpan.classList.remove('has-value');
            }
          }
        });

        // æ›´æ–°ç¸½è¨ˆ
        const totalSpan = row.querySelector('.total-value');
        if (totalSpan) {
          totalSpan.textContent = Math.round(entry.total);
        }
      });
    }
    function fillMissingDatesToToday() {
      if (!tableData.length) {
        showNotification('âŒ ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™ï¼Œç„¡æ³•è‡ªå‹•è£œæ»¿æ—¥æœŸ', true);
        return;
      }

      // æ‰¾å‡ºç›®å‰è³‡æ–™ä¸­ã€Œæœ€æ–°ã€æ—¥æœŸ
      let latest = null;
      tableData.forEach((entry) => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (isNaN(d)) return;
        if (!latest || d > latest) {
          latest = d;
        }
      });

      if (!latest) {
        showNotification('âŒ ç›®å‰è³‡æ–™æ—¥æœŸæ ¼å¼ç•°å¸¸ï¼Œç„¡æ³•è‡ªå‹•è£œæ»¿æ—¥æœŸ', true);
        return;
      }

      // å¾æœ€æ–°æ—¥æœŸçš„ä¸‹ä¸€å¤©é–‹å§‹è£œåˆ°ä»Šå¤©ï¼ˆå«ï¼‰
      const startDate = new Date(latest.getFullYear(), latest.getMonth(), latest.getDate() + 1);
      const today = new Date();
      const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      if (startDate > todayDateOnly) {
        showNotification('âœ… ç›®å‰å·²è£œæ»¿è‡³ä»Šæ—¥ï¼Œæ²’æœ‰æ–°å¢è³‡æ–™');
        return;
      }

      let added = 0;
      const addedDates = [];

      for (let d = new Date(startDate); d <= todayDateOnly; d.setDate(d.getDate() + 1)) {
        const dateStr = formatDateYYYYMMDD(d);
        const newEntry = {
          date: dateStr,
          v167: 0,
          v134: 0,
          v166: 0,
          v267: 0,
          remark: '',
          travelEnabled: newRowTravelEnabled,
        };
        tableData.push(newEntry);
        added++;
        addedDates.push(dateStr);
      }

      if (!added) {
        showNotification('âœ… ç›®å‰å·²è£œæ»¿è‡³ä»Šæ—¥ï¼Œæ²’æœ‰æ–°å¢è³‡æ–™');
        return;
      }

      // é‡æ–°æ’åºä¸¦é‡ç®—
      tableData.sort((a, b) => new Date(b.date) - new Date(a.date));
      updateAll();

      const first = addedDates[0];
      const last = addedDates[addedDates.length - 1];

      const formatMMDD = (iso) => {
        const mm = iso.slice(5, 7);
        const dd = iso.slice(8, 10);
        return `${mm}${dd}`;
      };

      const msg = `âœ… æ–°å¢ ${added} ç­†ï¼Œå¾ ${formatMMDD(first)} åˆ° ${formatMMDD(last)}`;
      showNotification(msg);
    }

    // æ–°å¢è³‡æ–™
    function addNewEntry(entry) {
      tableData.push(entry);
      tableData.sort((a, b) => new Date(b.date) - new Date(a.date)); // ç”±æ–°åˆ°èˆŠ
      updateAll();
    }

    // èª¿æ•´ OT æ•¸å€¼ï¼ˆä¸é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œåªæ›´æ–°æ•¸å€¼ï¼‰
    function adjustOTValue(entry, key, delta) {
      const newVal = Math.max(0, (entry[key] || 0) + delta);
      entry[key] = newVal;

      // åªæ›´æ–°è©²åˆ—çš„æ•¸å€¼å’Œè¨ˆç®—çµæœï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹è¡¨æ ¼
      updateAll(null, true); // å‚³å…¥ skipRender=true
    }

    // æ•¸å­—ç¿»ç‰Œå‹•ç•«é€šç”¨ helperï¼ˆé€ä½æ•¸ï¼‰
    function setAnimatedNumber(element, newValue) {
      if (!element) return;
      const newText = String(newValue);
      const oldText = element.dataset.value ?? element.textContent;

      if (oldText === newText) {
        element.dataset.value = newText;
        return;
      }

      element.dataset.value = newText;
      element.innerHTML = '';

      for (let i = 0; i < newText.length; i++) {
        const ch = newText[i];
        const span = document.createElement('span');
        span.textContent = ch;
        span.classList.add('digit');
        if (oldText[i] !== ch) {
          span.classList.add('flip');
        }
        element.appendChild(span);
      }
    }

    // ç°¡å–®çš„é€šçŸ¥æ°£æ³¡ï¼ˆæˆåŠŸ / å¤±æ•—æç¤ºï¼‰
    function showNotification(message, isError = false) {
      let bubble = document.getElementById('otNotifyBubble');
      if (!bubble) {
        bubble = document.createElement('div');
        bubble.id = 'otNotifyBubble';
        bubble.classList.add('ot-notify-bubble');
        // åŸºæœ¬æ¨£å¼ï¼Œä¹‹å¾Œå¯ç”¨ CSS è¦†è“‹
        bubble.style.position = 'fixed';
        bubble.style.left = '50%';
        bubble.style.top = '50%';
        bubble.style.transform = 'translate(-50%, -50%)';
        bubble.style.maxWidth = '320px';
        bubble.style.padding = '16px 18px';
        bubble.style.borderRadius = '12px';
        bubble.style.backgroundColor = '#222';
        bubble.style.color = '#fff';
        bubble.style.fontSize = '16px';
        bubble.style.lineHeight = '1.5';
        bubble.style.textAlign = 'center';
        bubble.style.boxShadow = '0 4px 12px rgba(0,0,0,0.25)';
        bubble.style.zIndex = '9999';
        bubble.style.whiteSpace = 'pre-line';
        document.body.appendChild(bubble);
      }

      bubble.classList.remove('error');
      if (isError) {
        bubble.classList.add('error');
        bubble.style.backgroundColor = '#b3261e';
      } else {
        bubble.style.backgroundColor = '#222';
      }

      bubble.textContent = message;
      bubble.style.display = 'block';

      if (bubble._hideTimer) {
        clearTimeout(bubble._hideTimer);
      }
      bubble._hideTimer = setTimeout(() => {
        bubble.style.display = 'none';
      }, 5000);
    }

    // åŒæ­¥ Travel Toggle UIï¼ˆæ–°å¢åˆ—ä¸Šçš„ Travel æŒ‰éˆ•ï¼‰
    function syncTravelToggleUI() {
      const travelToggleBtn = document.getElementById('travelToggle');
      if (travelToggleBtn) {
        if (newRowTravelEnabled) {
          travelToggleBtn.classList.add('on');
        } else {
          travelToggleBtn.classList.remove('on');
        }
      }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(openIndex = null) {
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.id = 'tableSection'; // 
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      // æ¨™é¡Œï¼ˆåˆªé™¤æ¬„æ”¾åœ¨æœ€å¾Œä¸€æ¬„ï¼‰
      const headerRow = document.createElement('tr');
      const headers = ['æ—¥æœŸ', '1.67', '1.34', '1.66', '2.67', 'è²»ç”¨ Total', 'æœˆè–ª', 'å‚™è¨»', ''];

      headers.forEach((h) => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // è‹¥å°šæœªè¼‰å…¥ä»»ä½•è³‡æ–™ï¼Œæ¸²æŸ“ç°¡å–®çš„å ä½å‡è¡¨ï¼ˆåªé¡¯ç¤ºä¸€åˆ—ï¼Œæ•´åˆ—ä½œç‚ºè¼‰å…¥æŒ‰éˆ•ï¼‰
      if (tableData.length === 0) {
        const tr = document.createElement('tr');
        tr.classList.add('placeholder-row');

        const td = document.createElement('td');
        td.colSpan = headers.length;
        td.classList.add('placeholder-load-cell');
        td.style.cursor = 'pointer';

        // ä¸­å¤®çš„ã€Œè¼‰å…¥ CSVã€è† å›Š
        const pill = document.createElement('span');
        pill.classList.add('placeholder-pill');
        pill.textContent = 'ğŸ“‚ è¼‰å…¥ CSV';
        td.appendChild(pill);

        td.addEventListener('click', () => {
          const importInput = document.getElementById('importCSVCard');
          if (importInput) {
            importInput.click();
          }
        });

        tr.appendChild(td);
        tbody.appendChild(tr);

        table.appendChild(thead);
        table.appendChild(tbody);
        container.appendChild(table);
        updateDashboard();
        return;
      }

      tableData.forEach((entry, index) => {
        // ===== ä¸»åˆ— =====
        const tr = document.createElement('tr');
        tr.classList.add('data-row');
        if (entry.weekday === 'æ—¥') tr.classList.add('sunday-row');

        // æ—¥æœŸï¼ˆé»æ“Šå¯ä¿®æ”¹ï¼‰
        const dateTd = document.createElement('td');
        dateTd.textContent = `${entry.date} (${entry.weekday})`;
        tr.appendChild(dateTd);

        dateTd.addEventListener('click', (e) => {
          e.stopPropagation();
          if (dateTd.querySelector('input')) return;

          const input = document.createElement('input');
          input.type = 'date';
          input.value = entry.date;
          input.classList.add('date-inline-input');

          dateTd.innerHTML = '';
          dateTd.appendChild(input);
          input.focus();

          const finish = (commit) => {
            if (!commit) {
              // å–æ¶ˆä¿®æ”¹ï¼Œé‚„åŸé¡¯ç¤º
              dateTd.innerHTML = `${entry.date} (${entry.weekday})`;
              return;
            }
            const newVal = input.value;
            if (!newVal) {
              dateTd.innerHTML = `${entry.date} (${entry.weekday})`;
              return;
            }
            entry.date = newVal;
            entry.weekday = getWeekdayChar(newVal);
            tableData.sort((a, b) => new Date(b.date) - new Date(a.date));
            updateAll();
          };

          input.addEventListener('blur', () => finish(true));
          input.addEventListener('keydown', (evt) => {
            if (evt.key === 'Enter') finish(true);
            if (evt.key === 'Escape') finish(false);
          });
        });

        // OT å››å€‹æ¬„ä½
        ['v167', 'v134', 'v166', 'v267'].forEach((key) => {
          const td = document.createElement('td');

          // å»ºç«‹ Number Stepper
          const stepper = document.createElement('div');
          stepper.classList.add('number-stepper');

          // æ¸›è™ŸæŒ‰éˆ•
          const minusBtn = document.createElement('button');
          minusBtn.type = 'button';
          minusBtn.classList.add('stepper-btn', 'minus');
          const minusIcon = document.createElement('span');
          minusIcon.classList.add('material-symbols-outlined');
          minusIcon.textContent = 'remove';
          minusBtn.appendChild(minusIcon);

          // æ•¸å€¼é¡¯ç¤º
          const valueSpan = document.createElement('span');
          valueSpan.classList.add('stepper-value');
          valueSpan.textContent = entry[key];
          // å¦‚æœæ•¸å€¼>0ï¼ŒåŠ å…¥ has-value class
          if (entry[key] > 0) {
            valueSpan.classList.add('has-value');
          }
          // åŠ è™ŸæŒ‰éˆ•
          const plusBtn = document.createElement('button');
          plusBtn.type = 'button';
          plusBtn.classList.add('stepper-btn', 'plus');
          const plusIcon = document.createElement('span');
          plusIcon.classList.add('material-symbols-outlined');
          plusIcon.textContent = 'add';
          plusBtn.appendChild(plusIcon);

          // é»æ“Šäº‹ä»¶
          minusBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            adjustOTValue(entry, key, -1);
            createRipple(e, minusBtn);
          });

          plusBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            adjustOTValue(entry, key, +1);
            createRipple(e, plusBtn);
          });

          // é•·æŒ‰å¿«é€Ÿå¢æ¸›
          let longPressTimer = null;
          const startLongPress = (btn, delta) => {
            longPressTimer = setInterval(() => {
              adjustOTValue(entry, key, delta);
            }, 150);
          };
          const stopLongPress = () => {
            if (longPressTimer) {
              clearInterval(longPressTimer);
              longPressTimer = null;
            }
          };

          minusBtn.addEventListener('mousedown', () => startLongPress(minusBtn, -1));
          minusBtn.addEventListener('mouseup', stopLongPress);
          minusBtn.addEventListener('mouseleave', stopLongPress);

          plusBtn.addEventListener('mousedown', () => startLongPress(plusBtn, +1));
          plusBtn.addEventListener('mouseup', stopLongPress);
          plusBtn.addEventListener('mouseleave', stopLongPress);

          // çµ„è£
          stepper.appendChild(minusBtn);
          stepper.appendChild(valueSpan);
          stepper.appendChild(plusBtn);
          td.appendChild(stepper);
          tr.appendChild(td);
        });

        // è²»ç”¨ Total
        const totalTd = document.createElement('td');
        const totalSpan = document.createElement('span');
        totalSpan.classList.add('capsule', 'black', 'total-value');
        totalSpan.textContent = Math.round(entry.total);
        totalTd.appendChild(totalSpan);
        tr.appendChild(totalTd);

        // æœˆè–ªï¼ˆæ¯æœˆç¬¬ä¸€ç­†é»ƒåº•ï¼Œå…¶é¤˜æ·±ç°ï¼‰
        const monthTd = document.createElement('td');
        const monthSpan = document.createElement('span');
        monthSpan.classList.add('capsule', 'salary-value', 'total-value');

        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        const firstIndex = tableData.findIndex(
          (e) => e.date && e.date.slice(0, 7) === monthKey
        );
        const isFirstOfMonth = firstIndex === index;

        if (isFirstOfMonth) {
          monthSpan.classList.add('yellow');
        } else {
          monthSpan.classList.add('dark-gray');
        }

        monthSpan.textContent = Math.round(entry.monthSLR);
        monthTd.appendChild(monthSpan);
        tr.appendChild(monthTd);

        // Remark
        const remarkTd = document.createElement('td');
        remarkTd.textContent = entry.remark;
        tr.appendChild(remarkTd);

        // åˆªé™¤åˆ—å°åœ“é»èˆ‡ç¢ºèªæ°£æ³¡ï¼ˆæ”¾åœ¨æœ€å³å´æ¬„ä½ï¼‰
        const deleteTd = document.createElement('td');
        const deleteWrapper = document.createElement('div');
        deleteWrapper.classList.add('row-delete-wrapper');

        const dotBtn = document.createElement('button');
        dotBtn.type = 'button';
        dotBtn.classList.add('row-dot');
        dotBtn.textContent = 'â—';

        const bubble = document.createElement('div');
        bubble.classList.add('delete-bubble');
        bubble.innerHTML = `
            <div class="delete-bubble-content">
                <p>åˆªé™¤é€™ä¸€åˆ—ï¼Ÿ</p>
                <div class="delete-bubble-actions">
                    <button type="button" class="delete-confirm">ç¢ºèª</button>
                    <button type="button" class="delete-cancel">å–æ¶ˆ</button>
                </div>
            </div>
        `;

        deleteWrapper.appendChild(dotBtn);
        deleteWrapper.appendChild(bubble);
        deleteTd.appendChild(deleteWrapper);
        tr.appendChild(deleteTd);

        dotBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // é—œé–‰å…¶ä»–åˆ—çš„æ°£æ³¡
          tbody.querySelectorAll('.delete-bubble.open').forEach((el) => {
            el.classList.remove('open');
          });
          bubble.classList.add('open');
        });

        const confirmBtn = bubble.querySelector('.delete-confirm');
        const cancelBtn = bubble.querySelector('.delete-cancel');

        confirmBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = tableData.indexOf(entry);
          if (idx !== -1) {
            tableData.splice(idx, 1);
            updateAll();
          }
        });

        cancelBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          bubble.classList.remove('open');
        });

        tbody.appendChild(tr);

        // ===== å­åˆ—ï¼šBase / Travel / OT Salary =====
        const detailTr = document.createElement('tr');
        detailTr.classList.add('detail-row');
        const detailTd = document.createElement('td');
        detailTd.colSpan = headers.length;

        const detailWrapper = document.createElement('div');
        detailWrapper.classList.add('detail-wrapper');

        const detailItems = [
          { key: 'base', label: 'Base' },
          { key: 'travel', label: 'Travel' },
          { key: 'otSalary', label: 'OT Salary' },
        ];

        detailItems.forEach((item) => {
          const block = document.createElement('div');
          block.classList.add('detail-chip');

          // è‹¥ç‚º Travelï¼ŒåŠ ä¸Šå¯é»æ“Šçš„ã€Œæ­¤åˆ—å°ˆç”¨ã€ toggle
          if (item.key === 'travel') {
            const travelToggleInline = document.createElement('button');
            travelToggleInline.type = 'button';
            travelToggleInline.classList.add('travel-toggle-inline');
            if (entry.travelEnabled) {
              travelToggleInline.classList.add('on');
            }
            travelToggleInline.addEventListener('click', (e) => {
              e.stopPropagation();
              entry.travelEnabled = !entry.travelEnabled;
              updateAll(index); // æ›´æ–°å¾Œç¶­æŒè©²åˆ—å­æ¸…å–®å±•é–‹
            });
            block.appendChild(travelToggleInline);
          }

          const labelSpan = document.createElement('span');
          labelSpan.classList.add('detail-label');
          labelSpan.textContent = item.label;

          const valueSpan = document.createElement('span');
          valueSpan.classList.add('capsule', 'dark-gray');
          valueSpan.textContent = Math.round(
            parseFloat(entry[item.key]) || 0
          );

          block.appendChild(labelSpan);
          block.appendChild(valueSpan);
          detailWrapper.appendChild(block);
        });

        detailTd.appendChild(detailWrapper);
        detailTr.appendChild(detailTd);
        if (openIndex === index) {
          detailTr.classList.add('open');
        }
        tbody.appendChild(detailTr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      container.appendChild(table);

      // é»æ“Šä¸»åˆ—å±•é–‹/æ”¶åˆ Base / Travel / OT Salary å­æ¸…å–®
      const dataRows = tbody.querySelectorAll('tr.data-row');
      dataRows.forEach((row) => {
        row.addEventListener('click', () => {
          const detail = row.nextElementSibling;
          if (!detail || !detail.classList.contains('detail-row')) return;

          const isOpen = detail.classList.contains('open');

          // é—œé–‰å…¶ä»–å·²é–‹å•Ÿçš„å­åˆ—
          tbody.querySelectorAll('tr.detail-row.open').forEach((dr) => {
            dr.classList.remove('open');
          });

          // å¦‚æœåŸæœ¬æ˜¯é—œé–‰çš„ï¼Œå°±æ‰“é–‹ï¼›å¦‚æœåŸæœ¬æ˜¯é–‹å•Ÿå°±ç¶­æŒé—œé–‰
          if (!isOpen) {
            detail.classList.add('open');
          }
        });
      });

      updateDashboard(); // æ¯æ¬¡æ¸²æŸ“è¡¨æ ¼å¾Œæ›´æ–°ç¸½è¨ˆ
      syncTravelToggleUI();
      console.log(
        'æ¯åˆ—æ¬„æ•¸:',
        tbody.querySelector('tr.data-row')?.children.length
      );
    }

    // æ–°å¢æŒ‰éˆ•äº‹ä»¶
    document.getElementById('addRowCard').addEventListener('click', () => {
      const newEntry = {
        date: document.getElementById('newDate').value,
        v167: parseFloat(document.getElementById('new167').value) || 0,
        v134: parseFloat(document.getElementById('new134').value) || 0,
        v166: parseFloat(document.getElementById('new166').value) || 0,
        v267: parseFloat(document.getElementById('new267').value) || 0,
        remark: document.getElementById('newRemark').value,
        travelEnabled: newRowTravelEnabled,
      };
      if (!newEntry.date) {
        alert('è«‹é¸æ“‡æ—¥æœŸ');
        return;
      }
      addNewEntry(newEntry);

      // æ¸…ç©ºè¼¸å…¥æ¬„ä½
      document.getElementById('newDate').value = '';
      document.getElementById('new167').value = '';
      document.getElementById('new134').value = '';
      document.getElementById('new166').value = '';
      document.getElementById('new267').value = '';
      document.getElementById('newRemark').value = '';
    });

    // === å°‡ç›®å‰è¡¨æ ¼è³‡æ–™æ•´ç†æˆå¯å¯«å› Sheet çš„çµæ§‹ ===
    function buildSheetPayload() {
      const headers = [
        'date',
        'weekday',
        '1.67',
        '1.34',
        '1.66',
        '2.67',
        'OT hr SUM',
        'Base',
        'Travel',
        'OT Salary',
        'Total',
        'Month SLR',
        'Remark',
      ];
      const rows = tableData.map((entry) => [
        entry.date || '',
        entry.weekday || getWeekdayChar(entry.date || ''),
        Number(entry.v167 || 0),
        Number(entry.v134 || 0),
        Number(entry.v166 || 0),
        Number(entry.v267 || 0),
        String(entry.otSum || 0),
        String(entry.base || 0),
        String(entry.travel || 0),
        String(entry.otSalary || 0),
        String(entry.total || 0),
        String(entry.monthSLR || 0),
        entry.remark || '',
      ]);
      return { headers, rows };
    }

    // === çµ±è¨ˆç”¨å·¥å…·å‡½å¼ï¼ˆæ–¹ä¾¿å…¶ä»–åœ°æ–¹é‡ç”¨ï¼‰ ===
    function getTotalRecordCount() {
      return tableData.length;
    }

    function getLatestMonthKey() {
      let latestDate = null;
      tableData.forEach((entry) => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (isNaN(d)) return;
        if (!latestDate || d > latestDate) {
          latestDate = d;
        }
      });
      if (!latestDate) return '';
      const yyyy = latestDate.getFullYear();
      const mm = String(latestDate.getMonth() + 1).padStart(2, '0');
      return `${yyyy}-${mm}`;
    }

    function getMonthlyTravelDays(monthKey) {
      if (!monthKey) return 0;
      return tableData.filter(
        (entry) => entry.date && entry.date.slice(0, 7) === monthKey
      ).length;
    }

    function getMonthlyOtHours(monthKey) {
      if (!monthKey) return 0;
      let sum = 0;
      tableData.forEach((entry) => {
        if (!entry.date || entry.date.slice(0, 7) !== monthKey) return;
        sum +=
          (parseFloat(entry.v167) || 0) +
          (parseFloat(entry.v134) || 0) +
          (parseFloat(entry.v166) || 0) +
          (parseFloat(entry.v267) || 0);
      });
      return sum;
    }

    function getMonthlySalary(monthKey) {
      if (!monthKey) return 0;
      const found = tableData.find(
        (entry) => entry.date && entry.date.slice(0, 7) === monthKey && entry.monthSLR
      );
      return found ? parseFloat(found.monthSLR) || 0 : 0;
    }

    function getMonthlyAverageDailySalary(monthKey) {
      if (!monthKey) return 0;
      let sum = 0;
      let count = 0;
      tableData.forEach((entry) => {
        if (!entry.date || entry.date.slice(0, 7) !== monthKey) return;
        const total = parseFloat(entry.total || 0);
        if (!isNaN(total)) {
          sum += total;
          count += 1;
        }
      });
      if (!count) return 0;
      return sum / count;
    }

    // å…±ç”¨ï¼šå–å¾—ç•¶æœˆæ‘˜è¦è¨Šæ¯
    function getMonthlySummaryText() {
      const totalCount = getTotalRecordCount();
      const monthKey = getLatestMonthKey();

      if (!monthKey) {
        return `å·²è¨˜éŒ„ ${totalCount} ç­†è³‡æ–™`;
      }

      const travelDays = getMonthlyTravelDays(monthKey);
      const otHours = getMonthlyOtHours(monthKey);
      const monthSalary = getMonthlySalary(monthKey);
      const avgDaily = getMonthlyAverageDailySalary(monthKey);

      const [year, month] = monthKey.split('-');
      const prettyMonth = `${year}/${month}`;

      const msgLines = [
        `å·²è¨˜éŒ„ ${totalCount} ç­†è³‡æ–™`,
        `${prettyMonth} å·²å‡ºå·® ${travelDays} å¤©`,
        `${prettyMonth} å·²åŠ ç­ ${otHours.toFixed(2)} å°æ™‚`,
        `${prettyMonth} æœˆè–ªï¼š${Math.round(monthSalary)}`,
        `${prettyMonth} å¹³å‡æ—¥è–ªï¼šç´„ ${Math.round(avgDaily)}`,
      ];

      return msgLines.join('\n');
    }

    // === è§¸ç™¼å¯«å› Google Sheet ===
    async function saveToSheet() {
      const payload = buildSheetPayload();

      // ç›´æ¥å˜—è©¦é€é google.script.run å‘¼å«å¾Œç«¯ï¼›è‹¥ä¸å­˜åœ¨å‰‡è¦–ç‚ºç´”å‰ç«¯ç’°å¢ƒ
      try {
        if (!google || !google.script || !google.script.run) {
          throw new Error('google.script.run not available');
        }
      } catch (e) {
        alert('è«‹å¾ Apps Script ç¶²é ç‰ˆæœ¬é–‹å•Ÿï¼Œæ‰èƒ½æŠŠè³‡æ–™å¯«å› Google Sheetã€‚\nç›®å‰é€™å€‹é é¢åƒ…ä½œç‚ºå‰ç«¯è©¦ç®—ä½¿ç”¨ã€‚');
        showNotification('âŒ ä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ° Google Apps Script ç’°å¢ƒ', true);
        return;
      }

      return new Promise((resolve, reject) => {
        const btn = document.getElementById('saveToSheetBtn');
        if (btn) btn.classList.add('loading');

        google.script.run
          .withSuccessHandler((res) => {
            if (btn) btn.classList.remove('loading');
            console.log('[OT] saveOvertimeData OK:', res);

            // æˆåŠŸå¾Œé¡¯ç¤ºç•¶å‰çµ±è¨ˆè³‡è¨Šï¼ˆå…±ç”¨çµ„å­—å‡½å¼ï¼‰
            const summary = getMonthlySummaryText();
            showNotification('âœ… ' + summary);

            resolve(res);
          })
          .withFailureHandler((err) => {
            if (btn) btn.classList.remove('loading');
            console.error('[OT] saveOvertimeData FAIL:', err);

            const errMsg = err && (err.message || err.toString()) ? (err.message || err.toString()) : 'æœªçŸ¥éŒ¯èª¤';
            alert('å¯«å› Google Sheet å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\nåŸå› ï¼š' + errMsg);
            showNotification('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + errMsg, true);

            reject(err);
          })
          .saveOvertimeData(payload);
      });
    }

    // åŒ¯å‡º CSV
    document
      .getElementById('exportCSVCard')
      .addEventListener('click', () => {
        let csv =
          'date,weekday,1.67,1.34,1.66,2.67,OT hr SUM,Base,Travel,OT Salary,Total,Month SLR,Remark\n';
        tableData.forEach((entry) => {
          csv +=
            [
              entry.date,
              entry.weekday,
              entry.v167,
              entry.v134,
              entry.v166,
              entry.v267,
              entry.otSum,
              entry.base,
              entry.travel,
              entry.otSalary,
              entry.total,
              entry.monthSLR,
              entry.remark,
            ].join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);

        // ä»¥æœ¬åœ°æ™‚é–“ç”¢ç”Ÿ yyyymmddï¼ˆä¾‹å¦‚ï¼š20251112ï¼‰
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const filename = `overtime_${yyyy}${mm}${dd}.csv`;

        link.download = filename;
        link.click();
      });

    // åŒ¯å…¥ CSV
    document
      .getElementById('importCSVCard')
      .addEventListener('change', function (e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function (event) {
          const text = event.target.result;
          parseCSV(text);
          updateAll();
        };
        reader.readAsText(file);
      });

    function parseCSV(text) {
      const lines = text
        .split('\n')
        .filter((line) => line.trim() !== '');
      tableData = lines.slice(1).map((line) => {
        const cols = line.split(',');
        return {
          date: cols[0],
          v167: parseFloat(cols[2]) || 0,
          v134: parseFloat(cols[3]) || 0,
          v166: parseFloat(cols[4]) || 0,
          v267: parseFloat(cols[5]) || 0,
          remark: cols[13] || '', // N æ¬„å‚™è¨»
          travelEnabled: true, // åŒ¯å…¥è³‡æ–™é è¨­æœ‰ Travelï¼Œä¹‹å¾Œå¯ç”¨ toggle é—œé–‰
        };
      });
    }

    // æ›´æ–° Dashboard ç¸½è¨ˆ
    function updateDashboard() {
      let totalOT = 0,
        totalBase = 0,
        totalTravel = 0,
        totalOTSalary = 0,
        totalCost = 0;
      const monthSalaryMap = {}; // key: 'YYYY-MM' -> è©²æœˆæœˆè–ªï¼Œåªå–ä¸€æ¬¡
      const travelDays = tableData.length; // â˜… å‡ºå·®å¤©æ•¸ = æ‰€æœ‰åˆ—æ•¸

      tableData.forEach((entry) => {
        totalOT +=
          (parseFloat(entry.v167) || 0) +
          (parseFloat(entry.v134) || 0) +
          (parseFloat(entry.v166) || 0) +
          (parseFloat(entry.v267) || 0);
        totalBase += parseFloat(entry.base || 0);
        totalTravel += parseFloat(entry.travel || 0);
        totalOTSalary += parseFloat(entry.otSalary || 0);
        totalCost += parseFloat(entry.total || 0);

        const monthKey = entry.date ? entry.date.slice(0, 7) : '';
        if (monthKey && entry.monthSLR) {
          // åªåœ¨ç¬¬ä¸€æ¬¡é‡åˆ°é€™å€‹æœˆä»½æ™‚è¨˜éŒ„
          if (!monthSalaryMap[monthKey]) {
            monthSalaryMap[monthKey] = parseFloat(entry.monthSLR) || 0;
          }
        }
      });

      // æ‰€æœ‰æœˆä»½çš„æœˆè–ªåŠ ç¸½
      const totalSalary = Object.values(monthSalaryMap).reduce(
        (sum, val) => sum + val,
        0
      );

      // â˜… æ–°å¢ï¼šå‡ºå·®å¤©æ•¸ï¼ˆæ‰€æœ‰åˆ—æ•¸ï¼‰
      setAnimatedNumber(
        document.getElementById('travelDays'),
        String(travelDays)
      );

      setAnimatedNumber(
        document.getElementById('totalOT'),
        totalOT.toFixed(2)
      );
      setAnimatedNumber(
        document.getElementById('totalBase'),
        Math.round(totalBase)
      );
      setAnimatedNumber(
        document.getElementById('totalTravel'),
        Math.round(totalTravel)
      );
      setAnimatedNumber(
        document.getElementById('totalOTSalary'),
        Math.round(totalOTSalary)
      );
      setAnimatedNumber(
        document.getElementById('totalCost'),
        Math.round(totalCost)
      );
      setAnimatedNumber(
        document.getElementById('totalSalary'),
        Math.round(totalSalary)
      );
    }

    // ç•¶æœˆè–ªæˆ–åŒ¯ç‡è¼¸å…¥è®Šæ›´æ™‚ï¼Œè‡ªå‹•é‡æ–°è¨ˆç®—
    document.getElementById('salary').addEventListener('input', () => {
      updateAll();
    });

    document.getElementById('usdRate').addEventListener('input', () => {
      updateAll();
    });

    // Travel åœ‹å®¶ä¸‹æ‹‰é¸å–®æ”¹è®Šæ™‚ï¼Œé‡æ–°è¨ˆç®—ï¼ˆè‹¥å°šæœªå»ºç«‹å‰‡ç•¥éï¼‰
    const travelCountrySelect = document.getElementById('travelCountry');
    if (travelCountrySelect) {
      travelCountrySelect.addEventListener('change', () => {
        updateAll();
      });
    }

    // æ–°å¢åˆ—ä¸Šçš„ Travel toggle æŒ‰éˆ•ï¼šåªæ§åˆ¶ã€Œæ–°è³‡æ–™é è¨­æ˜¯å¦æœ‰ Travelã€
    const travelToggleBtn = document.getElementById('travelToggle');
    if (travelToggleBtn) {
      travelToggleBtn.addEventListener('click', () => {
        newRowTravelEnabled = !newRowTravelEnabled;
        syncTravelToggleUI();
      });
    }

    // === Google Sheet ç›¸é—œå·¥å…·ï¼ˆHtmlService ç‰ˆï¼šå„ªå…ˆèµ° google.script.runï¼‰ ===

    // === Google Sheet ç›¸é—œå·¥å…·ï¼ˆHtmlService ç‰ˆï¼šç›´æ¥åƒ Template æ³¨å…¥çš„åˆå§‹è³‡æ–™ï¼‰ ===
    async function loadFromSheet() {
      try {
        const payload = window.__OT_INIT_PAYLOAD__;
        let rows = [];
        if (Array.isArray(payload)) {
          rows = payload;
        } else if (payload && Array.isArray(payload.data)) {
          rows = payload.data;
        }
        console.log('[OT] loadFromSheet from template payload, rows:', rows.length, 'raw payload:', payload);
        if (rows.length > 0) {
          // çµ±ä¸€äº¤çµ¦ä½ åŸæœ¬çš„æ¬„ä½è½‰æ›å‡½å¼
          initTableFromPayload({ data: rows });
        } else {
          // æ²’æ‹¿åˆ°è³‡æ–™å°±é¡¯ç¤ºç©ºè¡¨ï¼ˆå‡è¡¨ï¼‰
          renderTable();
          syncTravelToggleUI();
        }
      } catch (e) {
        console.warn('[OT] loadFromSheet è®€å– Template åˆå§‹è³‡æ–™å¤±æ•—ï¼Œé¡¯ç¤ºç©ºè¡¨ã€‚', e);
        renderTable();
        syncTravelToggleUI();
      }
    }

    function initTableFromPayload(payload) {
      const rows = payload && payload.data ? payload.data : [];
      tableData = rows.map((row) => {
        let rawDate = row.date;

        // Apps Script é€é google.script.run å‚³éä¾†ï¼Œdate å¯èƒ½æ˜¯ Date ç‰©ä»¶ï¼Œä¹Ÿå¯èƒ½æ˜¯å­—ä¸²
        if (rawDate instanceof Date) {
          const d = rawDate;
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          rawDate = `${yyyy}-${mm}-${dd}`;
        } else if (typeof rawDate === 'string') {
          // è‹¥æ˜¯ ISO å­—ä¸²ï¼ˆå« Tï¼‰ï¼Œè½‰æˆ YYYY-MM-DD
          if (rawDate.includes('T')) {
            const d = new Date(rawDate);
            if (!isNaN(d)) {
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth() + 1).padStart(2, '0');
              const dd = String(d.getDate()).padStart(2, '0');
              rawDate = `${yyyy}-${mm}-${dd}`;
            } else {
              rawDate = rawDate.slice(0, 10);
            }
          } else {
            // ä¸€èˆ¬å­—ä¸²æ ¼å¼ï¼Œä¿ç•™å‰ 10 ç¢¼ï¼ˆé æœŸæ˜¯ YYYY-MM-DD æˆ–é¡ä¼¼ï¼‰
            rawDate = rawDate.slice(0, 10);
          }
        } else {
          // å…¶å®ƒå‹åˆ¥ï¼ˆnull/undefinedï¼‰ï¼Œçµ¦ç©ºå­—ä¸²é¿å…å¾ŒçºŒå´©æ½°
          rawDate = '';
        }

        const v167 = Number(row.v167 ?? row['1.67'] ?? 0);
        const v134 = Number(row.v134 ?? row['1.34'] ?? 0);
        const v166 = Number(row.v166 ?? row['1.66'] ?? 0);
        const v267 = Number(row.v267 ?? row['2.67'] ?? 0);

        const baseRaw = row.base ?? row.Base ?? '';
        const travelRaw = row.travel ?? row.Travel ?? '';
        const otSalaryRaw = row.otSalary ?? row['OT Salary'] ?? '';
        const totalRaw = row.total ?? row.Total ?? '';
        const monthSlrRaw = row.monthSLR ?? row['Month SLR'] ?? '';
        const otSumRaw = row.otSum ?? row['OT hr SUM'] ?? '';
        const remarkRaw = row.remark ?? row.Remark ?? '';

        // ä¾ç…§ Sheet å…§å­˜çš„ Travel æ•¸å€¼æ±ºå®šé€™ä¸€åˆ—æ˜¯å¦ã€Œæœ‰å‡ºå·®ã€
        // Travel ç‚º 0 æˆ–ç©º â†’ è¦–ç‚ºç„¡å‡ºå·®ï¼ˆtravelEnabled = falseï¼‰
        const travelNum = Number(travelRaw) || 0;
        const travelEnabled = travelNum > 0;

        return {
          date: rawDate,
          weekday: row.weekday || (rawDate ? getWeekdayChar(rawDate) : ''),
          v167,
          v134,
          v166,
          v267,
          base: baseRaw.toString(),
          travel: travelRaw.toString(),
          otSalary: otSalaryRaw.toString(),
          total: totalRaw.toString(),
          monthSLR: monthSlrRaw.toString(),
          otSum: otSumRaw.toString(),
          remark: remarkRaw,
          travelEnabled,
        };
      });

      tableData.sort((a, b) => new Date(b.date) - new Date(a.date));
      updateAll();
    }

    // === End Google Sheet ç›¸é—œå·¥å…· ===

    // ç¶å®šã€Œå›å‚³åˆ° Google Sheetã€æŒ‰éˆ•ï¼ˆHTML ä¹‹å¾ŒåŠ ä¸Š id="saveToSheetBtn" å³å¯ï¼‰
    const saveBtn = document.getElementById('saveToSheetBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', async () => {
        try {
          saveBtn.disabled = true;
          await saveToSheet();
        } finally {
          saveBtn.disabled = false;
        }
      });
    } else {
      console.log(
        '[OT] saveToSheetBtn å°šæœªåŠ å…¥ HTMLï¼Œå¾…ä¹‹å¾ŒåŠ ä¸Šå³å¯ä½¿ç”¨ã€‚'
      );
    }

    const fillBtn = document.getElementById('fillMissingDatesBtn');
    if (fillBtn) {
      fillBtn.addEventListener('click', () => {
        fillMissingDatesToToday();
      });
    } else {
      console.log(
        '[OT] fillMissingDatesBtn å°šæœªåŠ å…¥ HTMLï¼Œå¾…ä¹‹å¾ŒåŠ ä¸Šå³å¯ä½¿ç”¨ã€‚'
      );
    }

    // åˆå§‹è¼‰å…¥ï¼šåœ¨ Apps Script Web App ä¸­æœƒå¾ Sheet è®€å–è³‡æ–™ï¼Œå…¶ä»–æƒ…æ³é¡¯ç¤ºç©ºç™½å‡è¡¨
    loadFromSheet();

    // é ç•™çµ¦ LOGO é»æ“Šå‘¼å«çš„å‡½å¼ï¼šé¡¯ç¤ºç•¶æœˆçµ±è¨ˆé€šçŸ¥
    if (global) {
      global.showOtMonthlySummary = function () {
        const summary = getMonthlySummaryText();
        showNotification('âœ… ' + summary);
      };

      // æš´éœ²åˆ°å…¨åŸŸä¾› Analytics ä½¿ç”¨
      global.updateAll = updateAll;
      global.showNotification = showNotification;
    }
  })(typeof globalThis !== 'undefined' ? globalThis : this); // â† é€™ä¸€è¡Œæ˜¯æ•´å€‹ wrapper çš„çµå°¾
</script>

<!-- è¼‰å…¥ Analytics å‡ç´šåŠŸèƒ½ -->
<script>
  // ç”±æ–¼ analytics.js éœ€è¦å­˜å– tableData ç­‰å…¨åŸŸè®Šæ•¸ï¼Œç›´æ¥åœ¨æ­¤å…§åµŒ

  // ========== åˆ†é åˆ‡æ› ==========
  function initTabNavigation() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const targetTab = btn.dataset.tab;

        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        const targetContent = document.getElementById(`${targetTab}-tab`);
        if (targetContent) {
          targetContent.classList.add('active');
        }

        if (targetTab === 'analytics') {
          updateCharts();
          updateAnalyticsStats();
        }
      });
    });
  }

  // ========== æœˆä»½éæ¿¾ ==========
  function populateMonthFilter() {
    const monthSet = new Set();
    tableData.forEach(entry => {
      if (entry.date) {
        const monthKey = entry.date.slice(0, 7);
        monthSet.add(monthKey);
      }
    });

    availableMonths = Array.from(monthSet).sort().reverse();

    const select = document.getElementById('monthFilter');
    if (!select) return;

    select.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>';
    availableMonths.forEach(month => {
      const option = document.createElement('option');
      option.value = month;
      const [year, monthNum] = month.split('-');
      option.textContent = `${year}å¹´${monthNum}æœˆ`;
      select.appendChild(option);
    });

    select.addEventListener('change', (e) => {
      selectedMonth = e.target.value || null;
      updateAll();
      updateCharts();
      updateAnalyticsStats();
    });
  }

  // ========== Chart.js åœ–è¡¨ ==========
  function initCharts() {
    if (typeof Chart === 'undefined') return;

    const ctx1 = document.getElementById('overtimeChart');
    if (ctx1) {
      charts.overtime = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'åŠ ç­æ™‚æ•¸',
            data: [],
            backgroundColor: 'rgba(160,231,160,0.8)',
            borderColor: 'rgba(160,231,160,1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });
    }

    const ctx2 = document.getElementById('incomeChart');
    if (ctx2) {
      charts.income = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Base è–ªè³‡', 'Travel æ´¥è²¼', 'OT åŠ ç­è²»'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: [
              'rgba(100,100,100,0.8)',
              'rgba(255,200,124,0.8)',
              'rgba(160,231,160,0.8)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }
  }

  function updateCharts() {
    if (!charts.overtime || !charts.income) return;

    const filteredData = selectedMonth
      ? tableData.filter(e => e.date && e.date.slice(0, 7) === selectedMonth)
      : tableData;

    const monthlyData = {};
    filteredData.forEach(entry => {
      const key = entry.date ? entry.date.slice(0, 7) : '';
      if (!key) return;

      if (!monthlyData[key]) {
        monthlyData[key] = { ot: 0, base: 0, travel: 0, otSalary: 0 };
      }

      monthlyData[key].ot += parseFloat(entry.otSum || 0);
      monthlyData[key].base += parseFloat(entry.base || 0);
      monthlyData[key].travel += parseFloat(entry.travel || 0);
      monthlyData[key].otSalary += parseFloat(entry.otSalary || 0);
    });

    const months = Object.keys(monthlyData).sort();
    charts.overtime.data.labels = months.map(m => m.slice(5));
    charts.overtime.data.datasets[0].data = months.map(m => monthlyData[m].ot);
    charts.overtime.update('none');

    let totalBase = 0, totalTravel = 0, totalOTSalary = 0;
    Object.values(monthlyData).forEach(d => {
      totalBase += d.base;
      totalTravel += d.travel;
      totalOTSalary += d.otSalary;
    });

    charts.income.data.datasets[0].data = [
      Math.round(totalBase),
      Math.round(totalTravel),
      Math.round(totalOTSalary)
    ];
    charts.income.update('none');
  }

  function updateAnalyticsStats() {
    const filteredData = selectedMonth
      ? tableData.filter(e => e.date && e.date.slice(0, 7) === selectedMonth)
      : tableData;

    const workDays = filteredData.length;
    const travelDays = filteredData.filter(e => e.travelEnabled).length;

    let totalOT = 0, totalIncome = 0;
    filteredData.forEach(entry => {
      totalOT += parseFloat(entry.otSum || 0);
      totalIncome += parseFloat(entry.total || 0);
    });

    const avgDaily = workDays > 0 ? totalIncome / workDays : 0;

    const setEl = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.textContent = val;
    };

    setEl('statWorkDays', workDays);
    setEl('statOTHours', totalOT.toFixed(1));
    setEl('statTravelDays', travelDays);
    setEl('statTotalIncome', Math.round(totalIncome).toLocaleString());
    setEl('statAvgDaily', Math.round(avgDaily).toLocaleString());
  }

  // ========== åŒ¯ç‡æ›´æ–° ==========
  const refreshBtn = document.getElementById('refreshRateBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      try {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler((rate) => {
              document.getElementById('usdRate').value = rate.toFixed(2);
              updateAll();
              showNotification(`âœ… åŒ¯ç‡å·²æ›´æ–°: 1 USD = ${rate.toFixed(2)} TWD`);
              refreshBtn.disabled = false;
            })
            .withFailureHandler(() => {
              showNotification('âŒ åŒ¯ç‡æ›´æ–°å¤±æ•—', true);
              refreshBtn.disabled = false;
            })
            .getExchangeRate('USD', 'TWD');
        } else {
          showNotification('âš ï¸ åƒ…åœ¨ Apps Script ç’°å¢ƒä¸­å¯ç”¨', true);
          refreshBtn.disabled = false;
        }
      } catch (err) {
        refreshBtn.disabled = false;
      }
    });
  }

  // Overview é é¢çš„åŒ¯ç‡æ›´æ–°æŒ‰éˆ•
  const refreshOverviewBtn = document.getElementById('refreshRateOverviewBtn');
  if (refreshOverviewBtn) {
    refreshOverviewBtn.addEventListener('click', async () => {
      refreshOverviewBtn.disabled = true;
      const icon = refreshOverviewBtn.querySelector('.material-symbols-outlined');
      if (icon) icon.style.animation = 'spin 1s linear infinite';

      try {
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler((rate) => {
              document.getElementById('usdRate').value = rate.toFixed(2);
              updateAll();
              showNotification(`âœ… åŒ¯ç‡å·²æ›´æ–°: 1 USD = ${rate.toFixed(2)} TWD`);
              refreshOverviewBtn.disabled = false;
              if (icon) icon.style.animation = '';
            })
            .withFailureHandler(() => {
              showNotification('âŒ åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', true);
              refreshOverviewBtn.disabled = false;
              if (icon) icon.style.animation = '';
            })
            .getExchangeRate('USD', 'TWD');
        } else {
          showNotification('âš ï¸ åƒ…åœ¨ Apps Script ç’°å¢ƒä¸­å¯ç”¨', true);
          refreshOverviewBtn.disabled = false;
          if (icon) icon.style.animation = '';
        }
      } catch (err) {
        refreshOverviewBtn.disabled = false;
        if (icon) icon.style.animation = '';
      }
    });
  }

  // Ripple æ•ˆæœå‡½æ•¸
  function createRipple(event, button) {
    const ripple = document.createElement('span');
    ripple.classList.add('ripple');

    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';

    button.appendChild(ripple);

    setTimeout(() => ripple.remove(), 600);
  }

  // ========== DOM è¼‰å…¥å¾Œåˆå§‹åŒ– ==========
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      initTabNavigation();
      populateMonthFilter();
      initCharts();
      updateCharts();
      updateAnalyticsStats();
      console.log('[OT] å‡ç´šåŠŸèƒ½å·²è¼‰å…¥ âœ…');
    }, 800);
  });
</script>